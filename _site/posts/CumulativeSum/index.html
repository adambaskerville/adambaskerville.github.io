<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="T&gt;T: Optimising Cumulative Sums in Python" /><meta property="og:locale" content="en" /><meta name="description" content="Methods to optimise cumulative sums in python." /><meta property="og:description" content="Methods to optimise cumulative sums in python." /><link rel="canonical" href="https://adambaskerville.github.io/posts/CumulativeSum/" /><meta property="og:url" content="https://adambaskerville.github.io/posts/CumulativeSum/" /><meta property="og:site_name" content="Dr Adam Luke Baskerville" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-07-23T00:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="T&gt;T: Optimising Cumulative Sums in Python" /><meta name="twitter:site" content="@SciBaskerville" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-12-08T10:59:15+00:00","datePublished":"2019-07-23T00:00:00+01:00","description":"Methods to optimise cumulative sums in python.","headline":"T&gt;T: Optimising Cumulative Sums in Python","mainEntityOfPage":{"@type":"WebPage","@id":"https://adambaskerville.github.io/posts/CumulativeSum/"},"url":"https://adambaskerville.github.io/posts/CumulativeSum/"}</script><title>T>T: Optimising Cumulative Sums in Python | Dr Adam Luke Baskerville</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Dr Adam Luke Baskerville"><meta name="application-name" content="Dr Adam Luke Baskerville"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="/assets/js/data/mathjax.js"></script> <script async src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-chtml.js"></script> <script> document.addEventListener('DOMContentLoaded', () => { const pv = document.getElementById('pageviews'); if (pv !== null) { const uri = location.pathname.replace(/\/$/, ''); const url = `https://albaskerville.goatcounter.com/counter/${encodeURIComponent(uri)}.json`; fetch(url) .then((response) => response.json()) .then((data) => { const count = data.count.replace(/\D/g, ''); pv.innerText = new Intl.NumberFormat().format(count); }) .catch((error) => { pv.innerText = '1'; }); } }); </script> <script defer src="/app.min.js?baseurl=&register=true" ></script> <script async src="https://gc.zgo.at/count.js" data-goatcounter="https://albaskerville.goatcounter.com/count" ></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/Baskerville_Bletchley_Crop.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">Dr Adam Luke Baskerville</a><p class="site-subtitle fst-italic mb-0">Quantum Physicist <a href=https://www.kvantify.com/>@Kvantify</a></p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>T>T</span> </a><li class="nav-item"> <a href="/presentations/" class="nav-link"> <i class="fa-fw fas fa-newspaper"></i> <span>PRESENTATIONS</span> </a><li class="nav-item"> <a href="/progchem/" class="nav-link"> <i class="fa-fw fas fa-newspaper"></i> <span>PROGRAMMING COURSE</span> </a><li class="nav-item"> <a href="/publications/" class="nav-link"> <i class="fa-fw fas fa-newspaper"></i> <span>PUBLICATIONS</span> </a><li class="nav-item"> <a href="/painting/" class="nav-link"> <i class="fa-fw fas fa-newspaper"></i> <span>PAINTING</span> </a><li class="nav-item"> <a href="/astrophotography/" class="nav-link"> <i class="fa-fw fas fa-newspaper"></i> <span>ASTROPHOTOGRAPHY</span> </a><li class="nav-item"> <a href="/astro/" class="nav-link"> <i class="fa-fw fas fa-newspaper"></i> <span>ASTROPITOGRAPHY</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/adambaskerville" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/SciBaskerville" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['adamlukebaskerville','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>T>T: Optimising Cumulative Sums in Python</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>T>T: Optimising Cumulative Sums in Python</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1563836400" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Jul 23, 2019 </time> </span> <span> Updated <time data-ts="1638961155" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Dec 8, 2021 </time> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/SciBaskerville">Adam Baskerville</a> </em> </span><div> <span> <em id="pageviews"> <i class="fas fa-spinner fa-spin small"></i> </em> views </span> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="2209 words" > <em>12 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">T>T: Optimising Cumulative Sums in Python</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">T>T: Optimising Cumulative Sums in Python</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><h2 id="the-problem"><span class="me-2">The Problem:</span><a href="#the-problem" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>We have a simple nested sum problem (aka cumulative sum): \[ \sum\limits_{a_i=0}^{a}\sum\limits_{b_i=0}^{b}\sum\limits_{c_i=0}^{c}\sum\limits_{d_i=0}^{d}\sum\limits_{e_i=0}^{e}\sum\limits_{f_i=0}^{f}\sum\limits_{g_i=0}^{a_i+b_i}\sum\limits_{h_i=0}^{c_i+d_i} \Omega, \] where \(\Omega\) represents arbitrary mathematical operations. There are 8 nested sums, with the inner two sums depending on the outer 4 sums. Let us put this into perspective:</p><p>For \(a = b = c = d = e = f = 10 \rightarrow\) 214358881 sum iterations</p><p>For \(a = b = c = d = e = f = 20 \rightarrow\) 37822859361 sum iterations</p><p>For \(a = b = c = d = e = f = 30 \rightarrow\) 852891037441 sum iterations</p><p>For \(a = b = c = d = e = f = 40 \rightarrow\) 7984925229121 sum iterations</p><p>For \(a = b = c = d = e = f = 50 \rightarrow\) 45767944570401 sum iterations</p><p>This just represents the number of ‘pass throughs’ of the sum that are required, and does not include the actual operations of the mathematics inside the nested sums. This is <strong>difficult</strong> from a computational standpoint due to the very large number of operations required. Let’s discuss how to implement this efficiently, and for this example, \(\Omega\) will have the form \[ \Omega = 2^{h_i - e_i + f_i - a_i - c_i - d_i + 1}(e_i^2 -2e_if_i - 7d_i)b_i!g_i!. \] A benchmark comparison of each solution is offered at the end of the post.</p><h2 id="solution-1-for-loops"><span class="me-2">Solution 1: For Loops</span><a href="#solution-1-for-loops" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The easiest option. Use <code class="language-plaintext highlighter-rouge">for</code> loops.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="k">def</span> <span class="nf">cumulative_sum_for_loops</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
    <span class="sh">'''</span><span class="s">
    This function calculates the cumulative sum using for loops
    </span><span class="sh">'''</span>
    <span class="n">Total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ai</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">bi</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ci</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">di</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">ei</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">fi</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">gi</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ai</span><span class="o">+</span><span class="n">bi</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">hi</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ci</span><span class="o">+</span><span class="n">di</span><span class="p">)</span> 
                                    <span class="n">Total</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">hi</span><span class="o">-</span><span class="n">ei</span><span class="o">+</span><span class="n">fi</span><span class="o">-</span><span class="n">ai</span><span class="o">-</span><span class="n">ci</span><span class="o">-</span><span class="n">di</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ei</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">ei</span><span class="o">*</span><span class="n">fi</span><span class="p">)</span><span class="o">-</span><span class="mi">7</span><span class="o">*</span><span class="n">di</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">math</span><span class="p">.</span><span class="nf">factorial</span><span class="p">(</span><span class="n">bi</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">math</span><span class="p">.</span><span class="nf">factorial</span><span class="p">(</span><span class="n">gi</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">Total</span>
</pre></table></code></div></div><p><strong>Pros</strong>: Very easy to program.</p><p><strong>Cons</strong>: Very slow.</p><h2 id="solution-2-cythonised-for-loops"><span class="me-2">Solution 2: Cythonised For Loops</span><a href="#solution-2-cythonised-for-loops" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>We will now use the same <code class="language-plaintext highlighter-rouge">for</code> loop structure but just use <strong>Cython</strong> to convert it into faster C code. The code below will be your <code class="language-plaintext highlighter-rouge">.pyx</code> file which you compile using a <code class="language-plaintext highlighter-rouge">setup.py</code> file.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="c1">#cython: language_level=3
</span><span class="n">cimport</span> <span class="n">cython</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="nd">@cython.boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>  <span class="c1"># Deactivate bounds checking
</span><span class="nd">@cython.wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>   <span class="c1"># Deactivate negative indexing.
</span><span class="n">cpdef</span> <span class="nf">cumulative_sum_for_loops</span><span class="p">(</span><span class="nb">int</span> <span class="n">a</span><span class="p">,</span> <span class="nb">int</span> <span class="n">b</span><span class="p">,</span> <span class="nb">int</span> <span class="n">c</span><span class="p">,</span> <span class="nb">int</span> <span class="n">d</span><span class="p">,</span> <span class="nb">int</span> <span class="n">e</span><span class="p">,</span> <span class="nb">int</span> <span class="n">f</span><span class="p">):</span>
    <span class="sh">'''</span><span class="s">
    This function calculates the cumulative sum using for loops
    </span><span class="sh">'''</span>
    <span class="n">cdef</span> <span class="nb">int</span> <span class="n">ai</span><span class="p">,</span> <span class="n">bi</span><span class="p">,</span> <span class="n">ci</span><span class="p">,</span> <span class="n">di</span><span class="p">,</span> <span class="n">fi</span><span class="p">,</span> <span class="n">gi</span><span class="p">,</span> <span class="n">hi</span>
    <span class="n">cdef</span> <span class="nb">long</span> <span class="n">double</span> <span class="n">Total</span>

    <span class="n">Total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ai</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">bi</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ci</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">di</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">ei</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">fi</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">gi</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ai</span><span class="o">+</span><span class="n">bi</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                                <span class="k">for</span> <span class="n">hi</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ci</span><span class="o">+</span><span class="n">di</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span> 
                                    <span class="n">Total</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">hi</span><span class="o">-</span><span class="n">ei</span><span class="o">+</span><span class="n">fi</span><span class="o">-</span><span class="n">ai</span><span class="o">-</span><span class="n">ci</span><span class="o">-</span><span class="n">di</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ei</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">ei</span><span class="o">*</span><span class="n">fi</span><span class="p">)</span><span class="o">-</span><span class="mi">7</span><span class="o">*</span><span class="n">di</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">math</span><span class="p">.</span><span class="nf">factorial</span><span class="p">(</span><span class="n">bi</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">math</span><span class="p">.</span><span class="nf">factorial</span><span class="p">(</span><span class="n">gi</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">Total</span>
</pre></table></code></div></div><p><strong>Pros</strong>: Very easy to program.</p><p><strong>Cons</strong>: Still slow.</p><h2 id="solution-3-grid-evaluation"><span class="me-2">Solution 3: Grid Evaluation</span><a href="#solution-3-grid-evaluation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Grid evaluation involves constructing an n-dimensional grid, where each dimension represents the range of a single <code class="language-plaintext highlighter-rouge">for</code> loop. We can then sweep over this n-dimensional grid with the mathematics in \(\Omega\) and sum everything together in one go; effectively converting the problem to a much more efficient matrix problem.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">scipy.special</span>

<span class="k">def</span> <span class="nf">cumulative_sum_grid</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
    <span class="sh">'''</span><span class="s">
    This function calculates the cumulative sum using a grid
    </span><span class="sh">'''</span>
    <span class="c1"># Setup the n-dimensional grid
</span>    <span class="n">ai</span><span class="p">,</span> <span class="n">bi</span><span class="p">,</span> <span class="n">ci</span><span class="p">,</span> <span class="n">di</span><span class="p">,</span> <span class="n">ei</span><span class="p">,</span> <span class="n">fi</span><span class="p">,</span> <span class="n">gi</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">ogrid</span><span class="p">[:</span><span class="n">a</span><span class="p">,</span> <span class="p">:</span><span class="n">b</span><span class="p">,</span> <span class="p">:</span><span class="n">c</span><span class="p">,</span> <span class="p">:</span><span class="n">d</span><span class="p">,</span> <span class="p">:</span><span class="n">e</span><span class="p">,</span> <span class="p">:</span><span class="n">f</span><span class="p">,</span> <span class="p">:</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="n">c</span> <span class="o">+</span> <span class="n">d</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="c1"># Calculate the mathematics within the summations
</span>    <span class="n">Total</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">hi</span> <span class="o">-</span> <span class="n">ei</span> <span class="o">-</span> <span class="n">fi</span> <span class="o">-</span> <span class="n">ai</span> <span class="o">-</span> <span class="n">ci</span> <span class="o">-</span> <span class="n">di</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ei</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">ei</span> <span class="o">*</span> <span class="n">fi</span><span class="p">)</span> <span class="o">-</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">di</span><span class="p">)</span> <span class="o">*</span> <span class="n">scipy</span><span class="p">.</span><span class="n">special</span><span class="p">.</span><span class="nf">factorial</span><span class="p">(</span><span class="n">bi</span><span class="p">)</span> <span class="o">*</span> <span class="n">scipy</span><span class="p">.</span><span class="n">special</span><span class="p">.</span><span class="nf">factorial</span><span class="p">(</span><span class="n">gi</span><span class="p">)</span>
    <span class="c1"># Mask out of range elements for last two inner loops
</span>    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">gi</span> <span class="o">&lt;</span> <span class="n">ai</span> <span class="o">+</span> <span class="n">bi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&lt;</span> <span class="n">ci</span> <span class="o">+</span> <span class="n">di</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> 

    <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">Total</span> <span class="o">*</span> <span class="n">mask</span><span class="p">)</span>
</pre></table></code></div></div><p><strong>Pros</strong>: Very fast.</p><p><strong>Cons</strong>: Very memory intensive.</p><p>This method is incredibly fast, but it uses a very large amount of Random Access Memory (RAM) to store the n-dimensional grid. My ThinkPad T430 has 16GB of RAM and the maximum value of \(a=b=c=d=e=f\) is 10 when the upper memory limit is reached. This method performs more computations than needed as the two inner loops have a varying number of iterations, hence will not require all the grid points allocated for it. This means you are evaluating more points on the grid than required and hence they are masked out at the end.</p><h2 id="solution-4-grid-evaluation-of-two-sums"><span class="me-2">Solution 4: Grid Evaluation of Two Sums</span><a href="#solution-4-grid-evaluation-of-two-sums" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Like Solution 2, but only evaluate the inner two sums using a grid.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">cumulative_sum_grid_two_sums</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
    <span class="sh">'''</span><span class="s">
    This function calculates the cumulative sum using a grid only on the inner two summations
    </span><span class="sh">'''</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">).</span><span class="nf">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="n">d</span><span class="p">)</span>

    <span class="n">Total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ai</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">bi</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
            <span class="n">gi</span> <span class="o">=</span> <span class="n">g</span><span class="p">[:</span><span class="n">ai</span> <span class="o">+</span> <span class="n">bi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ci</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">di</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
                    <span class="n">hi</span> <span class="o">=</span> <span class="n">h</span><span class="p">[:</span><span class="n">ci</span> <span class="o">+</span> <span class="n">di</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">ei</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">fi</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
                            <span class="n">Total</span> <span class="o">+=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sum</span><span class="p">((</span><span class="mf">2.</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="n">hi</span> <span class="o">-</span> <span class="n">ei</span> <span class="o">+</span> <span class="n">fi</span> <span class="o">-</span> <span class="n">ai</span> <span class="o">-</span> <span class="n">ci</span> <span class="o">-</span> <span class="n">di</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ei</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">ei</span> <span class="o">*</span> <span class="n">fi</span><span class="p">)</span> <span class="o">-</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">di</span><span class="p">)</span> <span class="o">*</span> <span class="n">scipy</span><span class="p">.</span><span class="n">special</span><span class="p">.</span><span class="nf">factorial</span><span class="p">(</span><span class="n">bi</span><span class="p">)</span> <span class="o">*</span> <span class="n">scipy</span><span class="p">.</span><span class="n">special</span><span class="p">.</span><span class="nf">factorial</span><span class="p">(</span><span class="n">gi</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">Total</span>
</pre></table></code></div></div><p><strong>Pros</strong>: Fast</p><p><strong>Cons</strong>: Still heavy on memory for large values of \(a,b,c,d,e,f\) but better than solution 3. A good compromise.</p><h2 id="solution-5-jit--vectorisation"><span class="me-2">Solution 5: JIT + Vectorisation</span><a href="#solution-5-jit--vectorisation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="https://en.wikipedia.org/wiki/Just-in-time_compilation">JIT</a> stands for Just In Time compilation, which is a way of executing computer code involving compilation during execution of a program - at run time - rather than prior to execution. This is implemented via the <code class="language-plaintext highlighter-rouge">Numba</code> library.</p><p><a href="https://www.oreilly.com/library/view/python-for-data/9781449323592/ch04.html">Vectorisation</a> is a very powerful programmatic technique well described by Wes McKinney:</p><p><em>“Arrays are important because they enable you to express batch operations on data without writing any for loops. This is usually called vectorization. Any arithmetic operations between equal-size arrays applies the operation elementwise.”</em> - <strong>Wes McKinney</strong></p><p>In this example, we are going to pre-evaluate some of the maths in \(\Omega\) and form a vector which we can index within the loops. The advantage of this is that for every <code class="language-plaintext highlighter-rouge">for</code> loop cycle the maths does not need to be reevaluated, instead being taken from the vector.</p><p>The maths in \(\Omega\) being vectorised is:</p><p>\[ \zeta = 2^{h_i - e_i + f_i - a_i - c_i - d_i + 1} \] Vectorising this expression means generating a vector containing all possible values the expression can equal. For us this means calculating the minimum and maximum value \(\zeta\) can be, providing us the two end points of our vector of pre-calculated results, which we can then fill.</p><p><strong>Minimum value:</strong></p><p>\(\zeta\) will be minimised when the exponent is as small as possible, i.e.</p><p>\[ \text{min}(h_i - e_i + f_i - a_i - c_i - d_i + 1) \] For addition operations we want to take the minimum value, and for subtraction operations we want to take the maximum value to form the smallest value possible. This means:</p><p>\(h_i = 0\) Smallest value \(h_i\) can be <br /> \(e_i = e\) Largest value \(e_i\) can be <br /> \(f_i = 0\) Smallest value \(f_i\) can be <br /> \(a_i = a\) Largest value \(a_i\) can be <br /> \(c_i = c\) Largest value \(c_i\) can be <br /> \(d_i = d\) Largest value \(d_i\) can be</p><p>Resulting in:</p><p>\[ 0 - (e - 1) + 0 - (a - 1) - (c - 1) - (d - 1) + 1 = \mathbf{5 - (e + a + c + d)} \]</p><p>This represents the smallest value that \(\zeta\) can ever be; hence the smallest value in our vector.</p><p><strong>Maximum value:</strong></p><p>\(\zeta\) will be maximised when the exponent is as large as possible, i.e.</p><p>\[ \text{max}(h_i - e_i + f_i - a_i - c_i - d_i + 1) \] \(h_i = (c + d)\) Largest value \(h_i\) can be <br /> \(e_i = 0\) Smallest value \(e_i\) can be <br /> \(f_i = f\) Largest value \(f_i\) can be <br /> \(a_i = 0\) Smallest value \(a_i\) can be <br /> \(c_i = 0\) Smallest value \(c_i\) can be <br /> \(d_i = 0\) Smallest value \(d_i\) can be</p><p>Resulting in:</p><p>\[ c + d + f + 1 \]</p><p>This represents the largest value that \(\zeta\) can ever be; hence the largest value in our vector. We will also precompute the two factorials, \(b_i!\) and \(g_i!\) which are much easier to vectorise.</p><p><strong>Minimum value:</strong></p><p>\(\text{min}(b_i!) = \text{min}(g_i!) = 0! = 1\)</p><p><strong>Maximum value:</strong></p><p>\(\text{max}(b_i!) = b!\) <br /> \(\text{max}(g_i!) = (a + b)!\)</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">numba</span> <span class="kn">import</span> <span class="n">njit</span> <span class="c1"># Import JIT library
</span><span class="kn">from</span> <span class="n">scipy.special</span> <span class="kn">import</span> <span class="n">factorial</span> <span class="c1"># Import factorial function from scipy
</span>
<span class="k">def</span> <span class="nf">cumulative_sum_vectorised_math</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
    <span class="sh">'''</span><span class="s">
    This function vectorises the mathematical expression in the nested sums
    </span><span class="sh">'''</span>
    <span class="n">exp_min</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="n">d</span> <span class="o">+</span> <span class="n">e</span><span class="p">)</span> <span class="c1"># Minimum value for exponent of zeta
</span>    <span class="n">exp_max</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="n">d</span> <span class="o">+</span> <span class="n">f</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1"># Maximum value for exponent of zeta
</span>    <span class="n">exp</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">**</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">exp_min</span><span class="p">,</span> <span class="n">exp_max</span><span class="p">)</span> <span class="c1"># All possible values of zeta
</span>
    <span class="n">b_fac_grid</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> 
    <span class="n">g_fac_grid</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> 

    <span class="n">fact_b</span> <span class="o">=</span> <span class="nf">factorial</span><span class="p">(</span><span class="n">b_fac_grid</span><span class="p">)</span> <span class="c1"># Factorial vector for b_i!
</span>    <span class="n">fact_g</span> <span class="o">=</span> <span class="nf">factorial</span><span class="p">(</span><span class="n">g_fac_grid</span><span class="p">)</span> <span class="c1"># Factorial vector for g_i!
</span>

    <span class="k">return</span> <span class="nf">cumulative_sum_JIT</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">exp_min</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">fact_b</span><span class="p">,</span> <span class="n">fact_g</span><span class="p">)</span>

<span class="nd">@njit</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">cumulative_sum_JIT</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">exp_min</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">fact_b</span><span class="p">,</span> <span class="n">fact_g</span><span class="p">):</span>
    <span class="sh">'''</span><span class="s">
    This function calculates the cumulative sum using JIT and vectorised maths
    </span><span class="sh">'''</span>
    <span class="n">Total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ai</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">bi</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ci</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">di</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">ei</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">fi</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">gi</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ai</span> <span class="o">+</span> <span class="n">bi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                                <span class="k">for</span> <span class="n">hi</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ci</span> <span class="o">+</span> <span class="n">di</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                                    <span class="c1"># We now index from the vectors, exp_min, exp_max, fact_b and fact_g whilst also applying JIT compilation using @njit()
</span>                                    <span class="n">Total</span> <span class="o">+=</span> <span class="n">exp</span><span class="p">[</span><span class="n">hi</span> <span class="o">-</span> <span class="n">ei</span> <span class="o">+</span> <span class="n">fi</span> <span class="o">-</span> <span class="n">ai</span> <span class="o">-</span> <span class="n">ci</span> <span class="o">-</span> <span class="n">di</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">exp_min</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">ei</span> <span class="o">*</span> <span class="n">ei</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">ei</span> <span class="o">*</span> <span class="n">fi</span><span class="p">)</span> <span class="o">-</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">di</span><span class="p">)</span> <span class="o">*</span> <span class="n">fact_b</span><span class="p">[</span><span class="n">bi</span><span class="p">]</span> <span class="o">*</span> <span class="n">fact_g</span><span class="p">[</span><span class="n">gi</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">Total</span>

</pre></table></code></div></div><p><strong>Pros:</strong> Fast and not RAM intensive.</p><p><strong>Cons:</strong> Vectorisation may prove much more difficult for more complex examples, and JIT compilation in python does not work well with <strong>NumPy</strong> or <strong>SciPy</strong>. This is one of the main reasons why \(b_i!\) and \(g_i!\) were precomputed as JIT will not work with the factorial implementation of <strong>SciPy</strong>. This is also limited to machine double precision which will be important later.</p><h2 id="benchmark"><span class="me-2">Benchmark</span><a href="#benchmark" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The following benchmark was conducted on my ThinkPad T430 laptop: Intel i7-3520M CPU @ 2.90GHz × 4, 16GiB RAM. For the purposes of this benchmark, \(a=b=c=d=e=f\) to simulate the toughest problem.</p><div style="text-align: center"><a href="/assets/img/CPUTimes.png" class="popup img-link shimmer"><img src="/assets/img/CPUTimes.png" loading="lazy"></a></div><p><strong>Solution 3</strong> is plotted, however I could only calculate up to \(a=b=c=d=e=f=10\) before my RAM limit was reached, so its data points are hidden behind the others.</p><p>As the above plot highlights, <code class="language-plaintext highlighter-rouge">for</code> loops are embarrasingly slow for this type of cumulative sum problem. <strong>Solution 2</strong> used Cython and achieved a nice speedup. <strong>Solution 3</strong> used grid evaluation which was fast but uses too much memory for conventional hardware. <strong>Solution 4</strong> only used grid evaluation for the inner two summations and results in a substantial speedup over the Cythonised <code class="language-plaintext highlighter-rouge">for</code> loops. However, <strong>Solution 5</strong> is the clear winner which used a combination of JIT and vectorised mathematics. It is over 3000 times faster than the <code class="language-plaintext highlighter-rouge">for</code> loop implementation for \(a=b=c=d=e=f=20\).</p><p><strong>Solution 1:</strong> 145873.077 s <br /> <strong>Solution 5:</strong> 48.441 s</p><h2 id="conclusion"><span class="me-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>This post has shown how to optimise a cumulative sum problem in Python. Five solutions were presented, and it was shown how a combination of JIT and vectorised mathematics resulted in an over 3000 x speedup over conventional <code class="language-plaintext highlighter-rouge">for</code> loops.</p><p>The inspiration behind this post comes from a mathematical calculation in my research which required a nested summation similar to this problem, but evaluated over 200,000 times for different values of \(a, b, c, d, e, f\). Not only this but it also required 200-digit precision, adding an even greater complexity to the problem.</p><p>The precision of this calculation is not discussed here, but going to high enough values of \(a,b,c,d,e,f\) will result in severe accumulation of errors due to the limitation of hardware double precision. Another post will discuss how to handle this.</p><p>The techniques discussed here are quite general, so can hopefully find place in any problems where it is tempting to default to nested <code class="language-plaintext highlighter-rouge">for</code> loops. parallelisation was also not discussed as we know ahead of time how much faster it will be (usually no. cores - 1 speedup).</p></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/science/" class="post-tag no-text-decoration" >Science</a> <a href="/tags/mathematics/" class="post-tag no-text-decoration" >Mathematics</a> <a href="/tags/programming/" class="post-tag no-text-decoration" >Programming</a> <a href="/tags/for-loops/" class="post-tag no-text-decoration" >for loops</a> <a href="/tags/optimising/" class="post-tag no-text-decoration" >optimising</a> <a href="/tags/jit/" class="post-tag no-text-decoration" >JIT</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=T%3ET:%20Optimising%20Cumulative%20Sums%20in%20Python%20-%20Dr%20Adam%20Luke%20Baskerville&url=https%3A%2F%2Fadambaskerville.github.io%2Fposts%2FCumulativeSum%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=T%3ET:%20Optimising%20Cumulative%20Sums%20in%20Python%20-%20Dr%20Adam%20Luke%20Baskerville&u=https%3A%2F%2Fadambaskerville.github.io%2Fposts%2FCumulativeSum%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fadambaskerville.github.io%2Fposts%2FCumulativeSum%2F&text=T%3ET:%20Optimising%20Cumulative%20Sums%20in%20Python%20-%20Dr%20Adam%20Luke%20Baskerville" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/am1bcc_speedup/">T>T: Turbocharging AM1BCC Charge Calculations</a><li class="text-truncate lh-lg"> <a href="/posts/BuffonNeedle/">T>T: Buffon's Needle: Estimating π using Toothpicks</a><li class="text-truncate lh-lg"> <a href="/posts/HighPrecisionEigenvalues/">T>T: High-Precision Eigenvalue Computations Made Efficient in C++</a><li class="text-truncate lh-lg"> <a href="/posts/DearpyguiCompilation/">T>T: Compiling DearPyGui on Raspberry Pi 32-bit OS</a><li class="text-truncate lh-lg"> <a href="/posts/Introduction-post/">T>T: Introduction</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/mathematics/">mathematics</a> <a class="post-tag btn btn-outline-primary" href="/tags/science/">science</a> <a class="post-tag btn btn-outline-primary" href="/tags/programming/">programming</a> <a class="post-tag btn btn-outline-primary" href="/tags/mathematics/">Mathematics</a> <a class="post-tag btn btn-outline-primary" href="/tags/programming/">Programming</a> <a class="post-tag btn btn-outline-primary" href="/tags/science/">Science</a> <a class="post-tag btn btn-outline-primary" href="/tags/python/">python</a> <a class="post-tag btn btn-outline-primary" href="/tags/chemistry/">chemistry</a> <a class="post-tag btn btn-outline-primary" href="/tags/matplotlib/">matplotlib</a> <a class="post-tag btn btn-outline-primary" href="/tags/length/">length</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/HartreeFockGuide/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1586646000" data-df="ll" > Apr 12, 2020 </time><h4 class="pt-0 my-2">T>T: Hartree Fock Theory in 100 Lines</h4><div class="text-muted"><p>Try the code yourself! Click the following button to launch an ipython notebook on Google Colab which implements the code developed in this post: In a previous post we looked at the hydrogen at...</p></div></div></a></article><article class="col"> <a href="/posts/Variational-Method-Hydrogen/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1579132800" data-df="ll" > Jan 16, 2020 </time><h4 class="pt-0 my-2">T>T: Solving the Hydrogen Atom Variationally</h4><div class="text-muted"><p>Try the code yourself! Click the following button to launch an ipython notebook on Google Colab which implements the code developed in this post: The Problem: We want to solve the Schrödinger ...</p></div></div></a></article><article class="col"> <a href="/posts/LespEigenvalues/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1575244800" data-df="ll" > Dec 2, 2019 </time><h4 class="pt-0 my-2">T>T: When Double Precision is Not Enough</h4><div class="text-muted"><p>Try the code yourself! Click the following button to launch an ipython notebook on Google Colab which implements the code developed in this post: The Problem: We want to solve the following st...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/Introduction-post/" class="btn btn-outline-primary" aria-label="Older" ><p>T>T: Introduction</p></a> <a href="/posts/PythonSubprocess/" class="btn btn-outline-primary" aria-label="Newer" ><p>T>T: Call C++ From Python Without Wrapping</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://twitter.com/SciBaskerville">Adam Baskerville</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.3.0" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/mathematics/">mathematics</a> <a class="post-tag btn btn-outline-primary" href="/tags/science/">science</a> <a class="post-tag btn btn-outline-primary" href="/tags/programming/">programming</a> <a class="post-tag btn btn-outline-primary" href="/tags/mathematics/">Mathematics</a> <a class="post-tag btn btn-outline-primary" href="/tags/programming/">Programming</a> <a class="post-tag btn btn-outline-primary" href="/tags/science/">Science</a> <a class="post-tag btn btn-outline-primary" href="/tags/python/">python</a> <a class="post-tag btn btn-outline-primary" href="/tags/chemistry/">chemistry</a> <a class="post-tag btn btn-outline-primary" href="/tags/matplotlib/">matplotlib</a> <a class="post-tag btn btn-outline-primary" href="/tags/length/">length</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
