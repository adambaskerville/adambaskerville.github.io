<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="T&gt;T: Turbocharging AM1BCC Charge Calculations" /><meta property="og:locale" content="en" /><meta name="description" content="The personal website of Adam Luke Baskerville Contains information and T&gt;T blog containing mathematics and science content" /><meta property="og:description" content="The personal website of Adam Luke Baskerville Contains information and T&gt;T blog containing mathematics and science content" /><link rel="canonical" href="https://adambaskerville.github.io/posts/am1bcc_speedup/" /><meta property="og:url" content="https://adambaskerville.github.io/posts/am1bcc_speedup/" /><meta property="og:site_name" content="Dr Adam Luke Baskerville" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-04-23T00:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="T&gt;T: Turbocharging AM1BCC Charge Calculations" /><meta name="twitter:site" content="@SciBaskerville" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-07-02T13:20:58+01:00","datePublished":"2023-04-23T00:00:00+01:00","description":"The personal website of Adam Luke Baskerville Contains information and T&gt;T blog containing mathematics and science content","headline":"T&gt;T: Turbocharging AM1BCC Charge Calculations","mainEntityOfPage":{"@type":"WebPage","@id":"https://adambaskerville.github.io/posts/am1bcc_speedup/"},"url":"https://adambaskerville.github.io/posts/am1bcc_speedup/"}</script><title>T>T: Turbocharging AM1BCC Charge Calculations | Dr Adam Luke Baskerville</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Dr Adam Luke Baskerville"><meta name="application-name" content="Dr Adam Luke Baskerville"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="/assets/js/data/mathjax.js"></script> <script async src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-chtml.js"></script> <script> document.addEventListener('DOMContentLoaded', () => { const pv = document.getElementById('pageviews'); if (pv !== null) { const uri = location.pathname.replace(/\/$/, ''); const url = `https://albaskerville.goatcounter.com/counter/${encodeURIComponent(uri)}.json`; fetch(url) .then((response) => response.json()) .then((data) => { const count = data.count.replace(/\D/g, ''); pv.innerText = new Intl.NumberFormat().format(count); }) .catch((error) => { pv.innerText = '1'; }); } }); </script> <script defer src="/app.min.js?baseurl=&register=true" ></script> <script async src="https://gc.zgo.at/count.js" data-goatcounter="https://albaskerville.goatcounter.com/count" ></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/Baskerville_Bletchley_Crop.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">Dr Adam Luke Baskerville</a><p class="site-subtitle fst-italic mb-0">Quantum Physicist <a href=https://www.kvantify.com/>@Kvantify</a></p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>T>T</span> </a><li class="nav-item"> <a href="/presentations/" class="nav-link"> <i class="fa-fw fas fa-newspaper"></i> <span>PRESENTATIONS</span> </a><li class="nav-item"> <a href="/progchem/" class="nav-link"> <i class="fa-fw fas fa-newspaper"></i> <span>PROGRAMMING COURSE</span> </a><li class="nav-item"> <a href="/publications/" class="nav-link"> <i class="fa-fw fas fa-newspaper"></i> <span>PUBLICATIONS</span> </a><li class="nav-item"> <a href="/painting/" class="nav-link"> <i class="fa-fw fas fa-newspaper"></i> <span>PAINTING</span> </a><li class="nav-item"> <a href="/astrophotography/" class="nav-link"> <i class="fa-fw fas fa-newspaper"></i> <span>ASTROPHOTOGRAPHY</span> </a><li class="nav-item"> <a href="/astro/" class="nav-link"> <i class="fa-fw fas fa-newspaper"></i> <span>ASTROPITOGRAPHY</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/adambaskerville" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/SciBaskerville" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['adamlukebaskerville','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>T>T: Turbocharging AM1BCC Charge Calculations</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>T>T: Turbocharging AM1BCC Charge Calculations</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1682204400" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Apr 23, 2023 </time> </span> <span> Updated <time data-ts="1751458858" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Jul 2, 2025 </time> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/SciBaskerville">Adam Baskerville</a> </em> </span><div> <span> <em id="pageviews"> <i class="fas fa-spinner fa-spin small"></i> </em> views </span> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="1495 words" > <em>8 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">T>T: Turbocharging AM1BCC Charge Calculations</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">T>T: Turbocharging AM1BCC Charge Calculations</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><h2 id="the-problem"><span class="me-2">The Problem</span><a href="#the-problem" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>AM1BCC charge calculations are painfully slow. A single ligand can take minutes instead of seconds, making high-throughput workflows impractical. The culprit? Unnecessary geometry optimisation.</p><h2 id="the-cause"><span class="me-2">The Cause</span><a href="#the-cause" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Most AM1BCC bottlenecks come from unnecessary geometry optimisation. AmberTools enables this by default without making it clear, so using standard settings triggers an expensive internal optimisation that’s redundant if your structures are already well-prepared. By setting <code class="language-plaintext highlighter-rouge">maxcyc=0</code> in the SQM settings, you can achieve significant speedups with minimal accuracy loss (<strong>caution</strong>: chemical space is vast and this will not always be true).</p><h2 id="the-solution"><span class="me-2">The Solution</span><a href="#the-solution" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ol><li><p>First, we need to verify AmberTools is available and working. AmberTools failures are cryptic so it is better to check upfront than debug mysterious errors later.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre> <span class="kn">import</span> <span class="n">os</span>
 <span class="kn">import</span> <span class="n">tempfile</span>
 <span class="kn">import</span> <span class="n">subprocess</span>
 <span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
 <span class="kn">from</span> <span class="n">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

 <span class="k">class</span> <span class="nc">FastAM1BCCCalculator</span><span class="p">:</span>
     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">ambertools_path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
         <span class="n">self</span><span class="p">.</span><span class="n">ambertools_path</span> <span class="o">=</span> <span class="n">ambertools_path</span>
         <span class="n">self</span><span class="p">.</span><span class="nf">_verify_ambertools</span><span class="p">()</span>
        
     <span class="k">def</span> <span class="nf">_verify_ambertools</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
         <span class="k">try</span><span class="p">:</span>
             <span class="n">cmd</span> <span class="o">=</span> <span class="sh">"</span><span class="s">antechamber</span><span class="sh">"</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">ambertools_path</span> <span class="k">else</span> \
                 <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">ambertools_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">bin</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">antechamber</span><span class="sh">"</span><span class="p">)</span>
             <span class="n">subprocess</span><span class="p">.</span><span class="nf">run</span><span class="p">([</span><span class="n">cmd</span><span class="p">,</span> <span class="sh">"</span><span class="s">-h</span><span class="sh">"</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
         <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
             <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">AmberTools not found: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</pre></table></code></div></div><li><p>Next we setup the SQM settings for AM1BCC. Setting <code class="language-plaintext highlighter-rouge">maxcyc=0</code> disables the internal geometry optimisation. If your input structure is already reasonable this optimisation is just expensive overhead.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre> <span class="k">def</span> <span class="nf">_get_sqm_settings</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">fast_mode</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
     <span class="sh">"""</span><span class="s">Generate SQM settings</span><span class="sh">"""</span>
     <span class="k">if</span> <span class="n">fast_mode</span><span class="p">:</span>
         <span class="c1"># maxcyc=0 is the key: NO geometry optimisation
</span>         <span class="k">return</span> <span class="sh">"</span><span class="s">qm_theory=</span><span class="sh">'</span><span class="s">AM1</span><span class="sh">'</span><span class="s">,maxcyc=0,ndiis_attempts=500,itrmax=500</span><span class="sh">"</span>
     <span class="k">else</span><span class="p">:</span>
         <span class="c1"># maxcyc=9999: FULL geometry optimisation (default, slow)
</span>         <span class="k">return</span> <span class="sh">"</span><span class="s">qm_theory=</span><span class="sh">'</span><span class="s">AM1</span><span class="sh">'</span><span class="s">,maxcyc=9999,ndiis_attempts=700,itrmax=1000</span><span class="sh">"</span>
</pre></table></code></div></div><li><p>For the purposes of this post we will create a simple function to read in a SMILES string, create a 3D structure and run a cheap MMFF optimisation on the structure.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre> <span class="k">def</span> <span class="nf">_prepare_molecule</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">smiles</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
     <span class="sh">"""</span><span class="s">convert SMILES to 3D structure</span><span class="sh">"""</span>
     <span class="kn">from</span> <span class="n">rdkit</span> <span class="kn">import</span> <span class="n">Chem</span>
     <span class="kn">from</span> <span class="n">rdkit.Chem</span> <span class="kn">import</span> <span class="n">AllChem</span>
        
     <span class="c1"># parse SMILES
</span>     <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="p">.</span><span class="nc">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
     <span class="k">if</span> <span class="n">mol</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
         <span class="k">raise</span> <span class="nc">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Invalid SMILES: </span><span class="si">{</span><span class="n">smiles</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
     <span class="c1"># add hydrogens; essential for proper charges
</span>     <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="p">.</span><span class="nc">AddHs</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
        
     <span class="c1"># generate 3D conformer
</span>     <span class="n">result</span> <span class="o">=</span> <span class="n">AllChem</span><span class="p">.</span><span class="nc">EmbedMolecule</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">randomSeed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
     <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
         <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sh">"</span><span class="s">Failed to generate 3D conformer</span><span class="sh">"</span><span class="p">)</span>
        
     <span class="c1"># quick MMFF optimisation; gives an ok starting point
</span>     <span class="n">AllChem</span><span class="p">.</span><span class="nc">MMFFOptimizeMolecule</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">maxIters</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
        
     <span class="k">return</span> <span class="n">mol</span>
</pre></table></code></div></div><li><p>We need to save our 3D molecule as a <code class="language-plaintext highlighter-rouge">.sdf</code> file as AmberTools reliably handles <code class="language-plaintext highlighter-rouge">.sdf</code> files.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre> <span class="k">def</span> <span class="nf">_write_sdf</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">:</span> <span class="n">Chem</span><span class="p">.</span><span class="n">Mol</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
     <span class="sh">"""</span><span class="s">Write molecule to SDF format for antechamber.</span><span class="sh">"""</span>
     <span class="kn">from</span> <span class="n">rdkit</span> <span class="kn">import</span> <span class="n">Chem</span>
        
     <span class="n">writer</span> <span class="o">=</span> <span class="n">Chem</span><span class="p">.</span><span class="nc">SDWriter</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
     <span class="n">writer</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
     <span class="n">writer</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
</pre></table></code></div></div><li><p>We now need to run the AM1BCC calculation which we will do by invoking the antechamber program using a subprocess call. We use the <code class="language-plaintext highlighter-rouge">-ek</code> parameter to pass our SQM settings to the calculation. Note, we parse the output in the <code class="language-plaintext highlighter-rouge">.mol2</code> format as it allows for charges to be natively stored in column 9 of the atom records.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre> <span class="k">def</span> <span class="nf">_run_antechamber</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">input_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sqm_settings</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">net_charge</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
     <span class="sh">"""</span><span class="s">Execute antechamber with our optimised settings.</span><span class="sh">"""</span>
        
     <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">antechamber</span><span class="sh">"</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">ambertools_path</span> <span class="k">else</span> 
             <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">ambertools_path</span><span class="p">,</span> <span class="sh">"</span><span class="s">bin</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">antechamber</span><span class="sh">"</span><span class="p">)]</span>
        
     <span class="n">output_mol2</span> <span class="o">=</span> <span class="n">work_dir</span> <span class="o">/</span> <span class="sh">"</span><span class="s">output.mol2</span><span class="sh">"</span>
        
     <span class="c1"># build the command with our optimised settings
</span>     <span class="n">cmd</span><span class="p">.</span><span class="nf">extend</span><span class="p">([</span>
         <span class="sh">"</span><span class="s">-i</span><span class="sh">"</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">input_file</span><span class="p">),</span> <span class="sh">"</span><span class="s">-fi</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">sdf</span><span class="sh">"</span><span class="p">,</span>        <span class="c1"># Input: SDF format
</span>         <span class="sh">"</span><span class="s">-o</span><span class="sh">"</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">output_mol2</span><span class="p">),</span> <span class="sh">"</span><span class="s">-fo</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">mol2</span><span class="sh">"</span><span class="p">,</span>      <span class="c1"># Output: MOL2 format  
</span>         <span class="sh">"</span><span class="s">-c</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">bcc</span><span class="sh">"</span><span class="p">,</span>                                <span class="c1"># AM1BCC charges
</span>         <span class="sh">"</span><span class="s">-nc</span><span class="sh">"</span><span class="p">,</span> <span class="nf">str</span><span class="p">(</span><span class="n">net_charge</span><span class="p">),</span>                     <span class="c1"># Net charge
</span>         <span class="sh">"</span><span class="s">-pf</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">yes</span><span class="sh">"</span><span class="p">,</span>                               <span class="c1"># Clean up temp files
</span>         <span class="sh">"</span><span class="s">-ek</span><span class="sh">"</span><span class="p">,</span> <span class="n">sqm_settings</span>                         <span class="c1"># Our faster sqm settings!
</span>     <span class="p">])</span>
        
     <span class="c1"># execute with timeout protection
</span>     <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
                             <span class="n">text</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        
     <span class="k">if</span> <span class="n">result</span><span class="p">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
         <span class="k">raise</span> <span class="nc">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Antechamber failed: </span><span class="si">{</span><span class="n">result</span><span class="p">.</span><span class="n">stderr</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        
     <span class="k">return</span> <span class="n">output_mol2</span>
</pre></table></code></div></div><li><p>We now create a function to run the calculation given an input SMILES string.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre> <span class="k">def</span> <span class="nf">calculate_charges</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">smiles</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fast_mode</span><span class="p">:</span><span class="nb">bool</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">net_charge</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
     <span class="sh">"""</span><span class="s">Calculate AM1BCC charges with speed optimisation.</span><span class="sh">"""</span>
        
     <span class="c1"># get optimised settings based on mode
</span>     <span class="n">sqm_settings</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_get_sqm_settings</span><span class="p">(</span><span class="n">fast_mode</span><span class="p">)</span>
        
     <span class="c1"># prepare the molecule
</span>     <span class="n">mol</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_prepare_molecule</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
        
     <span class="c1"># use temporary directory for clean execution
</span>     <span class="k">with</span> <span class="n">tempfile</span><span class="p">.</span><span class="nc">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">temp_dir</span><span class="p">:</span>
         <span class="n">temp_path</span> <span class="o">=</span> <span class="nc">Path</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>
            
         <span class="c1"># write input file
</span>         <span class="n">input_sdf</span> <span class="o">=</span> <span class="n">temp_path</span> <span class="o">/</span> <span class="sh">"</span><span class="s">input.sdf</span><span class="sh">"</span>
         <span class="n">self</span><span class="p">.</span><span class="nf">_write_sdf</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">input_sdf</span><span class="p">)</span>
            
         <span class="c1"># run antechamber
</span>         <span class="n">output_mol2</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_run_antechamber</span><span class="p">(</span>
             <span class="n">input_sdf</span><span class="p">,</span> <span class="n">temp_path</span><span class="p">,</span> <span class="n">sqm_settings</span><span class="p">,</span> <span class="n">net_charge</span>
         <span class="p">)</span>
            
         <span class="c1"># extract and return charges
</span>         <span class="n">charges</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">_parse_charges</span><span class="p">(</span><span class="n">output_mol2</span><span class="p">)</span>
            
         <span class="n">mode_desc</span> <span class="o">=</span> <span class="sh">"</span><span class="s">fast (no optimisation)</span><span class="sh">"</span> <span class="k">if</span> <span class="n">fast_mode</span> <span class="k">else</span> <span class="sh">"</span><span class="s">slow (full optimisation)</span><span class="sh">"</span>
         <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Calculated </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">charges</span><span class="p">)</span><span class="si">}</span><span class="s"> charges using </span><span class="si">{</span><span class="n">mode_desc</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            
         <span class="k">return</span> <span class="n">charges</span>
</pre></table></code></div></div></ol><h2 id="speed-test"><span class="me-2">Speed Test</span><a href="#speed-test" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Let’s benchmark the difference. First we will use a more complex, larger drug molecule to emphasise the speed improvement from not optimising.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">time</span>

<span class="c1"># test molecule: Atorvastatin
</span><span class="n">smiles</span> <span class="o">=</span> <span class="sh">"</span><span class="s">CC(C)C1=C(C(=C(N1CC[C@H](C[C@H](CC(=O)O)O)O)C2=CC=C(C=C2)F)C3=CC=CC=C3)C(=O)NC4=CC=CC=C4</span><span class="sh">"</span>
<span class="n">calculator</span> <span class="o">=</span> <span class="nc">FastAM1BCCCalculator</span><span class="p">()</span>

<span class="c1"># fast mode
</span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
<span class="n">charges_fast</span> <span class="o">=</span> <span class="n">calculator</span><span class="p">.</span><span class="nf">calculate_charges</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">fast_mode</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">time_fast</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

<span class="c1"># slow mode  
</span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
<span class="n">charges_slow</span> <span class="o">=</span> <span class="n">calculator</span><span class="p">.</span><span class="nf">calculate_charges</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">fast_mode</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">time_slow</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">No optimisation : </span><span class="si">{</span><span class="n">time_fast</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Optimisation (antechamber default): </span><span class="si">{</span><span class="n">time_slow</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">)</span> 
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Speedup: </span><span class="si">{</span><span class="n">time_slow</span><span class="o">/</span><span class="n">time_fast</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">x</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Charge difference: </span><span class="si">{</span><span class="n">np</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">abs</span><span class="p">(</span><span class="n">charges_fast</span> <span class="o">-</span> <span class="n">charges_slow</span><span class="p">))</span><span class="si">:</span><span class="p">.</span><span class="mi">6</span><span class="n">f</span><span class="si">}</span><span class="s"> e</span><span class="sh">"</span><span class="p">)</span>
</pre></table></code></div></div><p><strong>Results:</strong></p><ul><li><strong>No optimisation</strong>: 0.46s<li><strong>Optimisation (antechamber default)</strong>: 111.03s<li><strong>Speedup</strong>: 241.2x<li><strong>Charge difference</strong>: 0.025000 e</ul><p>We can see that the difference between the <code class="language-plaintext highlighter-rouge">antechamber</code> optimised and non-optimised partial charges is only 0.025e, but ran ~240 times faster!</p><h2 id="more-chemical-space"><span class="me-2">More Chemical Space</span><a href="#more-chemical-space" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Rather that using a single, cherry picked ligand lets now test some other ligands to get an indication of how it performs on different chemistry. We are going to pass through a range of different ligands with differing groups and produce a similarity plot of the optimised vs. non-optimised AM1BCC charges.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">analyze_charge_similarity</span><span class="p">():</span>
    <span class="sh">"""</span><span class="s">Compare optimised vs non-optimised AM1BCC charges across more molecules.</span><span class="sh">"""</span>
    <span class="kn">import</span> <span class="n">time</span>
    <span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
    <span class="kn">from</span> <span class="n">scipy.stats</span> <span class="kn">import</span> <span class="n">pearsonr</span>
    
    <span class="c1"># test set covering different chemical space
</span>    <span class="n">test_molecules</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sh">"</span><span class="s">Methanol</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">CO</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Ethanol</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">CCO</span><span class="sh">"</span><span class="p">,</span> 
        <span class="sh">"</span><span class="s">Acetone</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">CC(=O)C</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Benzene</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">C1=CC=CC=C1</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Caffeine</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">CN1C=NC2=C1C(=O)N(C(=O)N2C)C</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Aspirin</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">CC(=O)OC1=CC=CC=C1C(=O)O</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Glucose</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">C([C@@H]1[C@H]([C@@H]([C@H]([C@H](O1)O)O)O)O)O</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Toluene</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">CC1=CC=CC=C1</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Pyridine</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">C1=CC=NC=C1</span><span class="sh">"</span><span class="p">,</span>
        <span class="sh">"</span><span class="s">Morphine</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">CN1CC[C@]23c4c5ccc(O)c4O[C@H]2[C@@H](O)C=C[C@H]3[C@H]1C5</span><span class="sh">"</span>
    <span class="p">}</span>
    
    <span class="c1"># call our calculator
</span>    <span class="n">calculator</span> <span class="o">=</span> <span class="nc">FastAM1BCCCalculator</span><span class="p">()</span>
    
    <span class="n">correlations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">max_diffs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mol_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">times_fast</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">times_slow</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">.</span><span class="nf">flatten</span><span class="p">()</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="sh">'</span><span class="s">Molecule</span><span class="sh">'</span><span class="si">:</span><span class="o">&lt;</span><span class="mi">12</span><span class="n">s</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="sh">'</span><span class="s">Fast(s)</span><span class="sh">'</span><span class="si">:</span><span class="o">&lt;</span><span class="mi">8</span><span class="n">s</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="sh">'</span><span class="s">Slow(s)</span><span class="sh">'</span><span class="si">:</span><span class="o">&lt;</span><span class="mi">8</span><span class="n">s</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="sh">'</span><span class="s">Speedup</span><span class="sh">'</span><span class="si">:</span><span class="o">&lt;</span><span class="mi">8</span><span class="n">s</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="sh">'</span><span class="s">R</span><span class="sh">'</span><span class="si">:</span><span class="o">&lt;</span><span class="mi">8</span><span class="n">s</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="sh">'</span><span class="s">Max Δ</span><span class="sh">'</span><span class="si">:</span><span class="o">&lt;</span><span class="mi">8</span><span class="n">s</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">-</span><span class="sh">"</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">smiles</span><span class="p">)</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">test_molecules</span><span class="p">.</span><span class="nf">items</span><span class="p">()):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># time fast mode
</span>            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">charges_fast</span> <span class="o">=</span> <span class="n">calculator</span><span class="p">.</span><span class="nf">calculate_charges</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">fast_mode</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">time_fast</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
            
            <span class="c1"># time slow mode
</span>            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>
            <span class="n">charges_slow</span> <span class="o">=</span> <span class="n">calculator</span><span class="p">.</span><span class="nf">calculate_charges</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">fast_mode</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">time_slow</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
            
            <span class="c1"># calculate similarity metrics
</span>            <span class="n">correlation</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nf">pearsonr</span><span class="p">(</span><span class="n">charges_fast</span><span class="p">,</span> <span class="n">charges_slow</span><span class="p">)</span>
            <span class="n">max_diff</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">abs</span><span class="p">(</span><span class="n">charges_fast</span> <span class="o">-</span> <span class="n">charges_slow</span><span class="p">))</span>
            <span class="n">speedup</span> <span class="o">=</span> <span class="n">time_slow</span> <span class="o">/</span> <span class="n">time_fast</span>
            
            <span class="n">correlations</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">correlation</span><span class="p">)</span>
            <span class="n">max_diffs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">max_diff</span><span class="p">)</span>
            <span class="n">mol_names</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">times_fast</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">time_fast</span><span class="p">)</span>
            <span class="n">times_slow</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">time_slow</span><span class="p">)</span>
            
            <span class="c1"># plot scatter comparison
</span>            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">ax</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span><span class="n">charges_slow</span><span class="p">,</span> <span class="n">charges_fast</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
            
            <span class="c1"># correlation line
</span>            <span class="n">min_val</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">charges_slow</span><span class="p">.</span><span class="nf">min</span><span class="p">(),</span> <span class="n">charges_fast</span><span class="p">.</span><span class="nf">min</span><span class="p">())</span>
            <span class="n">max_val</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="n">charges_slow</span><span class="p">.</span><span class="nf">max</span><span class="p">(),</span> <span class="n">charges_fast</span><span class="p">.</span><span class="nf">max</span><span class="p">())</span>
            <span class="n">ax</span><span class="p">.</span><span class="nf">plot</span><span class="p">([</span><span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">],</span> <span class="p">[</span><span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">],</span> <span class="sh">'</span><span class="s">r--</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
            
            <span class="n">ax</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Optimised Charges (e)</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Non-optimised Charges (e)</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s">R = </span><span class="si">{</span><span class="n">correlation</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s">, </span><span class="si">{</span><span class="n">speedup</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">x faster</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">.</span><span class="nf">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="o">&lt;</span><span class="mi">12</span><span class="n">s</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">time_fast</span><span class="si">:</span><span class="o">&lt;</span><span class="mf">8.2</span><span class="n">f</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">time_slow</span><span class="si">:</span><span class="o">&lt;</span><span class="mf">8.2</span><span class="n">f</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">speedup</span><span class="si">:</span><span class="o">&lt;</span><span class="mf">8.1</span><span class="n">f</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">correlation</span><span class="si">:</span><span class="o">&lt;</span><span class="mf">8.4</span><span class="n">f</span><span class="si">}</span><span class="s"> </span><span class="si">{</span><span class="n">max_diff</span><span class="si">:</span><span class="o">&lt;</span><span class="mf">8.4</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="o">&lt;</span><span class="mi">12</span><span class="n">s</span><span class="si">}</span><span class="s"> FAILED - </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
    
    <span class="c1"># summary
</span>    <span class="n">total_time_fast</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">times_fast</span><span class="p">)</span>
    <span class="n">total_time_slow</span> <span class="o">=</span> <span class="nf">sum</span><span class="p">(</span><span class="n">times_slow</span><span class="p">)</span>
    <span class="n">overall_speedup</span> <span class="o">=</span> <span class="n">total_time_slow</span> <span class="o">/</span> <span class="n">total_time_fast</span>
    
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s">Summary:</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Mean correlation: </span><span class="si">{</span><span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">correlations</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Min correlation:  </span><span class="si">{</span><span class="n">np</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="n">correlations</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Mean max diff:    </span><span class="si">{</span><span class="n">np</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="n">max_diffs</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> e</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Max difference:   </span><span class="si">{</span><span class="n">np</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">max_diffs</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">4</span><span class="n">f</span><span class="si">}</span><span class="s"> e</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="se">\n</span><span class="s"> Timing Results:</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Total fast time:  </span><span class="si">{</span><span class="n">total_time_fast</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Total slow time:  </span><span class="si">{</span><span class="n">total_time_slow</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">s</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Overall speedup:  </span><span class="si">{</span><span class="n">overall_speedup</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">x</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Time saved:       </span><span class="si">{</span><span class="n">total_time_slow</span> <span class="o">-</span> <span class="n">total_time_fast</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">s (</span><span class="si">{</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">total_time_fast</span><span class="o">/</span><span class="n">total_time_slow</span><span class="p">)</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="s">%)</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">correlations</span><span class="p">,</span> <span class="n">max_diffs</span><span class="p">,</span> <span class="n">mol_names</span><span class="p">,</span> <span class="n">times_fast</span><span class="p">,</span> <span class="n">times_slow</span>

<span class="c1"># Run the analysis
</span><span class="n">correlations</span><span class="p">,</span> <span class="n">max_diffs</span><span class="p">,</span> <span class="n">mol_names</span><span class="p">,</span> <span class="n">times_fast</span><span class="p">,</span> <span class="n">times_slow</span> <span class="o">=</span> <span class="nf">analyze_charge_similarity</span><span class="p">()</span>
</pre></table></code></div></div><p>Running this results in:</p><p><strong>Summary:</strong></p><ul><li>Mean correlation: 0.9998<li>Min correlation: 0.9992<li>Mean max diff: 0.0138 e<li>Max difference: 0.0440 e</ul><p><strong>Timing Results:</strong></p><ul><li>Total fast time: 1.7s<li>Total slow time: 128.8s<li>Overall speedup: 73.8x<li>Time saved: 127.1s (98.6%)</ul><p>For just this small set of ligands we saved two minutes of computational time accounting for 98.6% of the total computation time; with little effect on the accuracy of the partial charges.</p><p>Below are the similarity plots of the charges for each molecule. As we have shown, the non-optimised and optimised AM1BCC charges are <strong>very</strong> similar.</p><p><a href="/assets/img/am1bcc/am1bcc_similarity_plot.png" class="popup img-link shimmer"><img src="/assets/img/am1bcc/am1bcc_similarity_plot.png" alt="Desktop View" loading="lazy"></a></p><h2 id="conclusion"><span class="me-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Setting <code class="language-plaintext highlighter-rouge">maxcyc=0</code> in the SQM settings for <code class="language-plaintext highlighter-rouge">antechamber</code> results in a significant speed improvement with little effect on accuracy (on average)</p><p>For most drug discovery workflows with pre-optimised structures, geometry optimisation is unnecessary overhead. Use fast mode when:</p><ul><li>Input geometries are well-prepared (RDKit/Schrodinger/MOE)<li>Processing large compound libraries<li>Doing screening calculations<li>Speed matters more than 0.1% accuracy</ul><p>Use slow mode when:</p><ul><li>Poor input geometries<li>Problematic molecules (unusual geometries/charges)</ul><p><strong>Bottom line</strong>: Start with fast mode. Only use slow mode if you encounter problems.</p></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/computational-chemistry/" class="post-tag no-text-decoration" >computational chemistry</a> <a href="/tags/python/" class="post-tag no-text-decoration" >python</a> <a href="/tags/optimisation/" class="post-tag no-text-decoration" >optimisation</a> <a href="/tags/ambertools/" class="post-tag no-text-decoration" >ambertools</a> <a href="/tags/am1bcc/" class="post-tag no-text-decoration" >am1bcc</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=T%3ET:%20Turbocharging%20AM1BCC%20Charge%20Calculations%20-%20Dr%20Adam%20Luke%20Baskerville&url=https%3A%2F%2Fadambaskerville.github.io%2Fposts%2Fam1bcc_speedup%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=T%3ET:%20Turbocharging%20AM1BCC%20Charge%20Calculations%20-%20Dr%20Adam%20Luke%20Baskerville&u=https%3A%2F%2Fadambaskerville.github.io%2Fposts%2Fam1bcc_speedup%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fadambaskerville.github.io%2Fposts%2Fam1bcc_speedup%2F&text=T%3ET:%20Turbocharging%20AM1BCC%20Charge%20Calculations%20-%20Dr%20Adam%20Luke%20Baskerville" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/am1bcc_speedup/">T>T: Turbocharging AM1BCC Charge Calculations</a><li class="text-truncate lh-lg"> <a href="/posts/BuffonNeedle/">T>T: Buffon's Needle: Estimating π using Toothpicks</a><li class="text-truncate lh-lg"> <a href="/posts/HighPrecisionEigenvalues/">T>T: High-Precision Eigenvalue Computations Made Efficient in C++</a><li class="text-truncate lh-lg"> <a href="/posts/DearpyguiCompilation/">T>T: Compiling DearPyGui on Raspberry Pi 32-bit OS</a><li class="text-truncate lh-lg"> <a href="/posts/Introduction-post/">T>T: Introduction</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/mathematics/">mathematics</a> <a class="post-tag btn btn-outline-primary" href="/tags/science/">science</a> <a class="post-tag btn btn-outline-primary" href="/tags/programming/">programming</a> <a class="post-tag btn btn-outline-primary" href="/tags/mathematics/">Mathematics</a> <a class="post-tag btn btn-outline-primary" href="/tags/programming/">Programming</a> <a class="post-tag btn btn-outline-primary" href="/tags/science/">Science</a> <a class="post-tag btn btn-outline-primary" href="/tags/python/">python</a> <a class="post-tag btn btn-outline-primary" href="/tags/chemistry/">chemistry</a> <a class="post-tag btn btn-outline-primary" href="/tags/matplotlib/">matplotlib</a> <a class="post-tag btn btn-outline-primary" href="/tags/length/">length</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/LocalProgramming/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1638489600" data-df="ll" > Dec 3, 2021 </time><h4 class="pt-0 my-2">T>T: Writing and Running Python Programs Locally</h4><div class="text-muted"><p>Purpose This post is designed as a supplement to my Python programming course. For new programmers it is not obvious how to go from writing a program to running it, and in this post we discuss a s...</p></div></div></a></article><article class="col"> <a href="/posts/LangtonsAnt2ElectricBoogaloo/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1598310000" data-df="ll" > Aug 25, 2020 </time><h4 class="pt-0 my-2">T>T: Langton's Ant 2: Electric Boogaloo</h4><div class="text-muted"><p>Update 26-Oct-2020: This post uses Matplotlib v3.1.0. Using v3.3.0 produces errors with the discrete color map as they have changed the functionality. Try the code yourself! Click the following b...</p></div></div></a></article><article class="col"> <a href="/posts/LangtonsAnt/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1595718000" data-df="ll" > Jul 26, 2020 </time><h4 class="pt-0 my-2">T>T: Order from Chaos: Langton's Ant</h4><div class="text-muted"><p>Try the code yourself! Click the following button to launch an ipython notebook on Google Colab which implements the code developed in this post: Langton’s Ant The inspiration for this post ca...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/BuffonNeedle/" class="btn btn-outline-primary" aria-label="Older" ><p>T>T: Buffon's Needle: Estimating π using Toothpicks</p></a><div class="btn btn-outline-primary disabled" aria-label="Newer"><p>-</p></div></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://twitter.com/SciBaskerville">Adam Baskerville</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.3.0" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/mathematics/">mathematics</a> <a class="post-tag btn btn-outline-primary" href="/tags/science/">science</a> <a class="post-tag btn btn-outline-primary" href="/tags/programming/">programming</a> <a class="post-tag btn btn-outline-primary" href="/tags/mathematics/">Mathematics</a> <a class="post-tag btn btn-outline-primary" href="/tags/programming/">Programming</a> <a class="post-tag btn btn-outline-primary" href="/tags/science/">Science</a> <a class="post-tag btn btn-outline-primary" href="/tags/python/">python</a> <a class="post-tag btn btn-outline-primary" href="/tags/chemistry/">chemistry</a> <a class="post-tag btn btn-outline-primary" href="/tags/matplotlib/">matplotlib</a> <a class="post-tag btn btn-outline-primary" href="/tags/length/">length</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
